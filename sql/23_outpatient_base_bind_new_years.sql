WITH steps_1_2 AS (
	SELECT
		-- Step 2 (create variables):
		v_BENE_ID,
		v_CLM_ID,
		v_CLM_THRU_DT,
		v_CLM_PMT_AMT,
		v_PRNCPAL_DGNS_CD,
		v_ICD_DGNS_CD1,
		v_ICD_DGNS_CD2,
		v_ICD_DGNS_CD3,
		v_ICD_DGNS_CD4,
		v_ICD_DGNS_CD5,
		v_ICD_DGNS_CD6,
		v_ICD_DGNS_CD7,
		v_ICD_DGNS_CD8,
		v_ICD_DGNS_CD9,
		v_ICD_DGNS_CD10,
		v_ICD_DGNS_CD11,
		v_ICD_DGNS_CD12,
		v_ICD_DGNS_CD13,
		v_ICD_DGNS_CD14,
		v_ICD_DGNS_CD15,
		v_ICD_DGNS_CD16,
		v_ICD_DGNS_CD17,
		v_ICD_DGNS_CD18,
		v_ICD_DGNS_CD19,
		v_ICD_DGNS_CD20,
		v_ICD_DGNS_CD21,
		v_ICD_DGNS_CD22,
		v_ICD_DGNS_CD23,
		v_ICD_DGNS_CD24,
		v_ICD_DGNS_CD25,
		EXTRACT(
			YEAR
			FROM
				v_CLM_THRU_DT
		) AS v_BENE_ENROLLMT_REF_YR
	FROM
		-- Step 1 (stack)
		(
			SELECT
				BENE_ID AS v_BENE_ID,
				CLM_ID AS v_CLM_ID,
				CLM_THRU_DT AS v_CLM_THRU_DT,
				CLM_PMT_AMT AS v_CLM_PMT_AMT,
				PRNCPAL_DGNS_CD AS v_PRNCPAL_DGNS_CD,
				ICD_DGNS_CD1 AS v_ICD_DGNS_CD1,
				ICD_DGNS_CD2 AS v_ICD_DGNS_CD2,
				ICD_DGNS_CD3 AS v_ICD_DGNS_CD3,
				ICD_DGNS_CD4 AS v_ICD_DGNS_CD4,
				ICD_DGNS_CD5 AS v_ICD_DGNS_CD5,
				ICD_DGNS_CD6 AS v_ICD_DGNS_CD6,
				ICD_DGNS_CD7 AS v_ICD_DGNS_CD7,
				ICD_DGNS_CD8 AS v_ICD_DGNS_CD8,
				ICD_DGNS_CD9 AS v_ICD_DGNS_CD9,
				ICD_DGNS_CD10 AS v_ICD_DGNS_CD10,
				ICD_DGNS_CD11 AS v_ICD_DGNS_CD11,
				ICD_DGNS_CD12 AS v_ICD_DGNS_CD12,
				ICD_DGNS_CD13 AS v_ICD_DGNS_CD13,
				ICD_DGNS_CD14 AS v_ICD_DGNS_CD14,
				ICD_DGNS_CD15 AS v_ICD_DGNS_CD15,
				ICD_DGNS_CD16 AS v_ICD_DGNS_CD16,
				ICD_DGNS_CD17 AS v_ICD_DGNS_CD17,
				ICD_DGNS_CD18 AS v_ICD_DGNS_CD18,
				ICD_DGNS_CD19 AS v_ICD_DGNS_CD19,
				ICD_DGNS_CD20 AS v_ICD_DGNS_CD20,
				ICD_DGNS_CD21 AS v_ICD_DGNS_CD21,
				ICD_DGNS_CD22 AS v_ICD_DGNS_CD22,
				ICD_DGNS_CD23 AS v_ICD_DGNS_CD23,
				ICD_DGNS_CD24 AS v_ICD_DGNS_CD24,
				ICD_DGNS_CD25 AS v_ICD_DGNS_CD25
			FROM
				_source_
			UNION ALL
			SELECT
				BENE_ID AS v_BENE_ID,
				CLM_ID AS v_CLM_ID,
				CLM_THRU_DT AS v_CLM_THRU_DT,
				CLM_PMT_AMT AS v_CLM_PMT_AMT,
				PRNCPAL_DGNS_CD AS v_PRNCPAL_DGNS_CD,
				ICD_DGNS_CD1 AS v_ICD_DGNS_CD1,
				ICD_DGNS_CD2 AS v_ICD_DGNS_CD2,
				ICD_DGNS_CD3 AS v_ICD_DGNS_CD3,
				ICD_DGNS_CD4 AS v_ICD_DGNS_CD4,
				ICD_DGNS_CD5 AS v_ICD_DGNS_CD5,
				ICD_DGNS_CD6 AS v_ICD_DGNS_CD6,
				ICD_DGNS_CD7 AS v_ICD_DGNS_CD7,
				ICD_DGNS_CD8 AS v_ICD_DGNS_CD8,
				ICD_DGNS_CD9 AS v_ICD_DGNS_CD9,
				ICD_DGNS_CD10 AS v_ICD_DGNS_CD10,
				ICD_DGNS_CD11 AS v_ICD_DGNS_CD11,
				ICD_DGNS_CD12 AS v_ICD_DGNS_CD12,
				ICD_DGNS_CD13 AS v_ICD_DGNS_CD13,
				ICD_DGNS_CD14 AS v_ICD_DGNS_CD14,
				ICD_DGNS_CD15 AS v_ICD_DGNS_CD15,
				ICD_DGNS_CD16 AS v_ICD_DGNS_CD16,
				ICD_DGNS_CD17 AS v_ICD_DGNS_CD17,
				ICD_DGNS_CD18 AS v_ICD_DGNS_CD18,
				ICD_DGNS_CD19 AS v_ICD_DGNS_CD19,
				ICD_DGNS_CD20 AS v_ICD_DGNS_CD20,
				ICD_DGNS_CD21 AS v_ICD_DGNS_CD21,
				ICD_DGNS_CD22 AS v_ICD_DGNS_CD22,
				ICD_DGNS_CD23 AS v_ICD_DGNS_CD23,
				ICD_DGNS_CD24 AS v_ICD_DGNS_CD24,
				ICD_DGNS_CD25 AS v_ICD_DGNS_CD25
			FROM
				`stanfordphs.medicare_20_2019_2020_outpatient:e3fc:v1_0.outpatient_base_claim_file:nb00`
		)
) 
SELECT
	v_BENE_ID AS BENE_ID,
	v_CLM_ID AS CLM_ID,
	v_CLM_THRU_DT AS CLM_THRU_DT,
	v_PRNCPAL_DGNS_CD AS PRNCPAL_DGNS_CD,
	v_ICD_DGNS_CD1 AS ICD_DGNS_CD1,
	v_ICD_DGNS_CD2 AS ICD_DGNS_CD2,
	v_ICD_DGNS_CD3 AS ICD_DGNS_CD3,
	v_ICD_DGNS_CD4 AS ICD_DGNS_CD4,
	v_ICD_DGNS_CD5 AS ICD_DGNS_CD5,
	v_ICD_DGNS_CD6 AS ICD_DGNS_CD6,
	v_ICD_DGNS_CD7 AS ICD_DGNS_CD7,
	v_ICD_DGNS_CD8 AS ICD_DGNS_CD8,
	v_ICD_DGNS_CD9 AS ICD_DGNS_CD9,
	v_ICD_DGNS_CD10 AS ICD_DGNS_CD10,
	v_ICD_DGNS_CD11 AS ICD_DGNS_CD11,
	v_ICD_DGNS_CD12 AS ICD_DGNS_CD12,
	v_ICD_DGNS_CD13 AS ICD_DGNS_CD13,
	v_ICD_DGNS_CD14 AS ICD_DGNS_CD14,
	v_ICD_DGNS_CD15 AS ICD_DGNS_CD15,
	v_ICD_DGNS_CD16 AS ICD_DGNS_CD16,
	v_ICD_DGNS_CD17 AS ICD_DGNS_CD17,
	v_ICD_DGNS_CD18 AS ICD_DGNS_CD18,
	v_ICD_DGNS_CD19 AS ICD_DGNS_CD19,
	v_ICD_DGNS_CD20 AS ICD_DGNS_CD20,
	v_ICD_DGNS_CD21 AS ICD_DGNS_CD21,
	v_ICD_DGNS_CD22 AS ICD_DGNS_CD22,
	v_ICD_DGNS_CD23 AS ICD_DGNS_CD23,
	v_ICD_DGNS_CD24 AS ICD_DGNS_CD24,
	v_ICD_DGNS_CD25 AS ICD_DGNS_CD25,
	v_CLM_PMT_AMT AS CLM_PMT_AMT,
	v_BENE_ENROLLMT_REF_YR AS BENE_ENROLLMT_REF_YR
FROM
	`steps_1_2`